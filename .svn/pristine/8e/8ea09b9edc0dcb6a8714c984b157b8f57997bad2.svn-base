/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package cr.cdrb.web.edu.dao;

import cr.cdrb.commons.db.DbUtilsPlus;
import cr.cdrb.web.edu.daointerface.IUserdao;
import cr.cdrb.web.edu.security.domains.Role;
import cr.cdrb.web.edu.security.domains.Users;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import javax.annotation.Resource;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Repository;

/**
 *
 * @author Jayang
 */
@Repository
public class UsersDao implements IUserdao {

    @Resource(name = "db2")
    private DbUtilsPlus db;

    public Users GetUsers(String usernmae) throws SQLException {
        Users endUser = new Users();
        //检查数据是否已经存在
        String queryStr = "select S.身份证号码 workername,U.username from S1_职工基本信息 S\n"
                + "join users U on U.username=S.身份证号码\n"
                + "where 身份证号码='" + usernmae + "'";
        Users quser = db.queryBean(Users.class, queryStr);
        if (quser == null) {
            usernmae = "users";//设置为默认访问用户
        } else //老职工表存在，新用户表不存在则向新用户表插入一条数据
         if (quser.getWorkername() != null && quser.getUsername() == null) {
                String sqlInsert = "insert into users values('" + usernmae + "','21232f297a57a5a743894a0e4a801fc3')";
                db.insert(sqlInsert);
            }
        String sqlStr = "select U.username,U.password,S1.rolename,S1.roleid,S1.rolecmt,Z.姓名 as workername,Z.性别 as sex,Z.单位 as company,Z.政治面貌 as political,Z.所在部门 as department,Z.所在工班 as gang,Z.现任职务 as post,Z.职称 as title,Z.技术等级 as technicalgrade,Z.岗位 as station from Users U "
                + " left join S1_职工基本信息  Z on Z.身份证号码=U.username "
                + " left join user_roles  R on R.username=U.username "
                + " left join roles S1 on S1.roleid=R.roleid where U.username='" + usernmae + "'  "
                + " union  "
                + " select U1.username,U1.password,S.rolename,S.roleid,S.rolecmt,Z1.姓名 as workername,Z1.性别 as sex,Z1.单位 as company,Z1.政治面貌 as political,Z1.所在部门 as department,Z1.所在工班 as gang,Z1.现任职务 as post,Z1.职称 as title,Z1.技术等级 as technicalgrade,Z1.岗位 as station from Users U1 "
                + " left join S1_职工基本信息  Z1 on Z1.身份证号码=U1.username "
                + " left join group_members G on G.username=U1.username "
                + " left join group_roles  R1 on R1.group_id=G.id "
                + " left  join roles S on S.roleid=R1.roleid  where U1.username='" + usernmae + "' ";
        List<Users> userList = db.queryBeanList(Users.class, sqlStr);
        if (userList.size() == 0) {
            throw new UsernameNotFoundException("未匹配到用户");
        }
        List<Role> roles = new ArrayList<Role>();
        boolean ismap = true;
        for (Users user : userList) {
            if (ismap) {
                endUser = user;
                ismap = false;
            }
            Role role = new Role();
            role.setRoleid(user.getRoleid());
            role.setRolename(user.getRolename());
            role.setRolecmt(user.getRolecmt());
            if (user.getRolename() != null) {
                roles.add(role);
            }
        }
        endUser.setRoles(roles);
        return endUser;
    }
}
