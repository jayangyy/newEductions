/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package cr.cdrb.web.edu.services;

import cr.cdrb.web.edu.dao.EmployeeDao;
import cr.cdrb.web.edu.daointerface.IEduClassDao;
import cr.cdrb.web.edu.daointerface.IEduPlansDao;
import cr.cdrb.web.edu.daointerface.IPlanReview;
import cr.cdrb.web.edu.domains.easyui.DataModel;
import cr.cdrb.web.edu.domains.easyui.QueryModel;
import cr.cdrb.web.edu.domains.educlass.EduProf;
import cr.cdrb.web.edu.domains.eduplans.EduAbroadType;
import cr.cdrb.web.edu.domains.eduplans.EduHighspeedFlag;
import cr.cdrb.web.edu.domains.eduplans.EduPlanCost;
import cr.cdrb.web.edu.domains.eduplans.EduPlanSearch;
import cr.cdrb.web.edu.domains.eduplans.EduPlanTransfer;
import cr.cdrb.web.edu.domains.eduplans.EduPlans;
import cr.cdrb.web.edu.domains.eduplans.EduPlansTransDto;
import cr.cdrb.web.edu.domains.eduplans.EduReviewSimpleStatus;
import cr.cdrb.web.edu.domains.eduplans.EduReviews;
import cr.cdrb.web.edu.domains.eduplans.EduSocTraintype;
import cr.cdrb.web.edu.domains.eduplans.EduSocialExecunit;
import cr.cdrb.web.edu.domains.eduplans.EduSocialMainunit;
import cr.cdrb.web.edu.model.Employee;
import cr.cdrb.web.edu.services.IServices.IPlansService;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 *
 * @author Jayang 培训计划服务类
 */
@Service
public class PlanService implements IPlansService {

    @Autowired
    IEduPlansDao plansDao;
    @Autowired
    IPlanReview reviewDao;
    @Autowired
    EmployeeDao employeeDao;
    @Autowired
    IEduClassDao classDao;

    @Override

    // <editor-fold desc="培训计划制定">
    public DataModel addPlan(EduPlans plan) throws SQLException {
        return plansDao.addPlan(plan) ? new DataModel().withInfo("新增计划成功") : new DataModel().withErr("新增计划失败");
    }

    @Override
    public DataModel updatePlan(EduPlans plan) throws SQLException {
        EduPlans plan1 = plansDao.getPlanById(plan.getPlan_code());
        if (plan1 == null) {
            throw new SQLException("未找到该计划！");
        }
        if (!plan1.getAdd_user().equalsIgnoreCase(UsersService.GetCurrentUser().getUsername())) {
            throw new SQLException("你没有修改此计划权限！");
        }
        if (plansDao.hasPlanLoading(plan.getPlan_code())) {
            throw new SQLException("存在待办计划未完成，不能完结！");
        }
        if (plansDao.hasPlanLoading(plan.getPlan_code())) {
            return new DataModel().withErr("还有待办未完成，不能修改计划！");
        } else {
            return plansDao.updatePlan(plan) ? new DataModel().withInfo("修改计划成功") : new DataModel().withErr("修改计划失败");
        }
    }

    @Override
    public DataModel getPlansPages(EduPlanSearch model) throws Throwable {
        Map<Integer, List<EduPlansTransDto>> resPaging = plansDao.getPlansPage(model);
        Integer key;
        key = (Integer) resPaging.keySet().toArray()[0];
        return new DataModel().withData(resPaging.get(key), key);
    }

    @Override
    public DataModel removePlan(String ids) throws SQLException {
        EduPlans plan1 = plansDao.getPlanById(ids);
        if (plan1 == null) {
            throw new SQLException("未找到该计划！");
        }
        if (!plan1.getAdd_user().equalsIgnoreCase(UsersService.GetCurrentUser().getWorkername())) {
            throw new SQLException("你没有删除此计划权限！");
        }
        if (plansDao.hasPlanLoading(ids)) {
            throw new SQLException("存在待办计划未完成，不能完结！");
        }
        return plansDao.removePlan(ids) ? new DataModel().withInfo("删除计划成功") : new DataModel().withErr("删除计划失败,稍后重试!");
    }

    @Override
    public EduPlans getPlan(String id) throws SQLException {
        return plansDao.getPlanById(id);
    }
    // </editor-fold>

    // <editor-fold desc="培训计划审核">
    @Override
    public DataModel addReview(EduReviews plan) throws SQLException {
        return reviewDao.addReview(plan) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel updateReview(EduReviews plan) throws SQLException {
        return reviewDao.updateReview(plan) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel removeReview(String ids) throws SQLException {
        return reviewDao.removeReview(ids) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");

    }

    @Override
    public DataModel getReviewPage(QueryModel pageModel) throws Throwable {
        Map<Integer, List<EduReviews>> resPaging = reviewDao.getReviewPage(pageModel);
        Integer key;
        key = (Integer) resPaging.keySet().toArray()[0];
        return new DataModel().withData(resPaging.get(key), key);
    }

    @Override
    public EduReviews getReview(String id) throws SQLException {
        return reviewDao.getReviewById(id);
    }

    @Override
    public List<EduReviews> getReviews(Object... params) throws SQLException {
        return reviewDao.getReview(params);
    }
    // </editor-fold>

    @Override
    public List<EduProf> getProfs(Object... uids) throws SQLException {
        return plansDao.getProfs(uids);
    }

    @Override
    public EduPlans getPlanInclude(String id) throws SQLException {
        return plansDao.getPlanInclude(id);
    }

    @Override
    public List<EduPlans> getPlans(Object... id) throws SQLException {
        return plansDao.getPlans(id);
    }

    @Override
    public DataModel transOfficPlan(EduPlans plan) throws SQLException {
        EduPlans plan1 = plansDao.getPlanById(plan.getPlan_code());
        List<EduPlanTransfer> list = plan.getPlantranfers();
        for (EduPlanTransfer trans : list) {
            if (trans.getTransfer_to_idcard().equals(plan1.getAdd_user())) {
                throw new SQLException("不能移交给拟稿人！");
            }
        }
        return plansDao.transferPlan(plan) ? new DataModel().withInfo("操作成功") : new DataModel().withErr("操作失败");
    }

    @Override
    public DataModel getEmployeePage(QueryModel pageModel, String unit, String username) throws Throwable {
        String whereSql = " 1=1 ";
        List<String> params = new ArrayList<String>();
        if (unit != null) {
            if (unit.length() > 0) {
                whereSql += "  and dwname=?";
                params.add(unit);
            }
        }
        if (username != null) {
            if (username.length() > 0) {
                whereSql += " and em_name like '%" + username + "%'";
                //  params.add("%"+ username+"%");
            }
        }
        pageModel.setFilterRules(whereSql);
        Map<Integer, List<Employee>> resPaging = employeeDao.getEmployeePaging(pageModel.getPage(), pageModel.getRows(), pageModel.getSort(), pageModel.getOrder(), pageModel.getFilterRules(), pageModel.getSearch(), params.toArray());
        Integer key;
        key = (Integer) resPaging.keySet().toArray()[0];
        return new DataModel().withData(resPaging.get(key), key);
    }

    @Override
    public DataModel overPlan(EduReviews review) throws SQLException {
//还有待办事项，不能完结
        if (plansDao.hasPlanLoading(review.getPlan_code())) {
            throw new SQLException("存在待办事项，不能完结！");
        }
//职教/财务盖章才能算通过
        List<EduPlanCost> ilist = plansDao.getHasFlag(review.getPlan_code());
        for (EduPlanCost item : ilist) {
            if (item.getCost_persons() <= 0) {
                throw new SQLException("没有必要部门签章，无法完结！");
            }
        }
        return plansDao.overPlan(review) ? new DataModel().withInfo("操作成功") : new DataModel().withErr("操作失败");
    }

    @Override
    public DataModel throwPlan(EduReviews review) throws SQLException {
        return plansDao.throwPlan(review) ? new DataModel().withInfo("操纵成功") : new DataModel().withErr("操作失败");
    }

    @Override
    public DataModel getTransPlanPage(EduPlanSearch pageModel) throws Throwable {
        Map<Integer, List<EduPlansTransDto>> resPaging = plansDao.getTransPlanPage(pageModel);
        Integer key;
        key = (Integer) resPaging.keySet().toArray()[0];
        return new DataModel().withData(resPaging.get(key), key);
    }

    @Override
    public DataModel authPassed(EduReviews review) throws SQLException {
        EduPlanTransfer transfer = plansDao.getTransferById(review.getTransfer_code());
        if (transfer == null) {
            throw new SQLException("未找到移交记录");
        }
        if (transfer.getTrans_status() == EduReviewSimpleStatus.经办.getStats()) {
            throw new SQLException("已完成,不能修改！");
        }
        EduPlans plan = plansDao.getPlanById(review.getPlan_code());
        if (plan == null) {
            throw new SQLException("未找到计划");
        }
        if (plan.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats() || plan.getPlan_status() == EduReviewSimpleStatus.处室经办.getStats()) {
            throw new SQLException("此计划已由处室完结或废弃，不能在做修改！");
        }
        return plansDao.authReview(review) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel authTransfer(List<EduReviews> review, List<EduPlanTransfer> transfers) throws SQLException {
        if (!(review.size() > 0 && transfers.size() > 0)) {
            throw new SQLException("参数不能为空！");
        }
        EduPlanTransfer transfer = plansDao.getTransferById(review.get(0).getTransfer_code());
        if (transfer == null) {
            throw new SQLException("未找到移交记录");
        }
        if (transfer.getTrans_status() == EduReviewSimpleStatus.经办.getStats()) {
            throw new SQLException("已完成,不能修改！");
        }
        EduPlans plan = plansDao.getPlanById(review.get(0).getPlan_code());
        if (plan == null) {
            throw new SQLException("未找到计划");
        }
        for (EduPlanTransfer trans : transfers) {
            if (plan.getAdd_user().equals(trans.getTransfer_to_idcard())) {
                throw new SQLException("不能直接移交拟稿人" + trans.getTransfer_to_user() + "，请去掉拟稿人选择！");
            }
        }
        if (plan.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats() || plan.getPlan_status() == EduReviewSimpleStatus.处室经办.getStats()) {
            throw new SQLException("此计划已由处室完结或废弃，不能在做修改！");
        }
        return plansDao.unitsTransfer(review, transfers) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel authBacktop(EduReviews review) throws SQLException {
        EduPlanTransfer transfer = plansDao.getTransferById(review.getTransfer_code());
        if (transfer == null) {
            throw new SQLException("未找到移交记录");
        }
        if (transfer.getTrans_status() == EduReviewSimpleStatus.经办.getStats()) {
            throw new SQLException("已完成,不能修改！");
        }
        EduPlans plan = plansDao.getPlanById(review.getPlan_code());
        if (plan == null) {
            throw new SQLException("未找到计划");
        }
        if (plan.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats() || plan.getPlan_status() == EduReviewSimpleStatus.处室经办.getStats()) {
            throw new SQLException("此计划已由处室完结或废弃，不能在做修改！");
        }
        return plansDao.authBacktop(review) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel authBackuser(EduReviews review, EduPlanTransfer transfer) throws SQLException {
        EduPlanTransfer transfers = plansDao.getTransferById(review.getTransfer_code());
        if (transfers == null) {
            throw new SQLException("未找到移交记录");
        }
        if (transfer.getTrans_status() == EduReviewSimpleStatus.经办.getStats()) {
            throw new SQLException("已完成，废弃，或由处室完结,不能修改！");
        }
        EduPlans plan = plansDao.getPlanById(review.getPlan_code());
        if (plan == null) {
            throw new SQLException("未找到计划");
        }
        if (plan.getAdd_user().equals(transfer.getTransfer_to_idcard())) {
            throw new SQLException("不能直接移交拟稿人，请选择返拟稿人操作！");
        }
        if (plan.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats() || plan.getPlan_status() == EduReviewSimpleStatus.处室经办.getStats()) {
            throw new SQLException("此计划已由处室完结或废弃，不能在做修改！");
        }
        return plansDao.authBackuser(review, transfer) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel transferFinance(EduPlanCost cost, EduPlans plan) throws SQLException {
        EduPlans plan1 = plansDao.getPlanById(plan.getPlan_code());
        List<EduPlanTransfer> list = plan.getPlantranfers();
        for (EduPlanTransfer trans : list) {
            if (trans.getTransfer_to_idcard().equals(plan1.getAdd_user())) {
                throw new SQLException("不能移交给拟稿人，请使用返拟稿人操作！");
            }
        }
        if (plan1.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats()) {
            throw new SQLException("此计划已废弃，不能在做财务移交以及建班！");
        }
        //计划人数已安排完，不能提交申请
        int persons = classDao.getPersonNum(plan1.getPlan_code(), "");
        if (persons == plan1.getPlan_num()) {
            throw new SQLException("培训班总人数已达到该计划培训总人数" + persons + "人，不能再建班！");
        }
        int endnum = plan1.getPlan_num() - persons;
        if (cost.getCost_persons() > endnum) {
            throw new SQLException("人数超标，还能安排" + endnum + "人！");
        }
        if (plan1.getPlan_days() < cost.getCost_days()) {
            throw new SQLException("培训班天数不能大于" + plan1.getPlan_days() + "！");
        }
        return plansDao.transferFinance(cost, plan) ? new DataModel().withInfo("操作成功") : new DataModel().withErr("操作失败");
    }

    @Override
    public EduPlanCost getFinanceInclude(String plan_code, String cost_code) throws SQLException {
        return plansDao.getFinanceInclude(plan_code, cost_code);
    }

    @Override
    public DataModel financeTransfer(List<EduReviews> review, List<EduPlanTransfer> transfers, String cost) throws SQLException {
        if (!(review.size() > 0 && transfers.size() > 0)) {
            throw new SQLException("参数不能为空！");
        }
//        EduPlanTransfer transfer = plansDao.getTransferById(review.get(0).getTransfer_code());
//        if (transfer == null) {
//            throw new SQLException("未找到移交记录");
//        }
//        if (transfer.getTrans_status() == EduReviewSimpleStatus.经办.getStats()) {
//            throw new SQLException("已完成,不能修改！");
//        }
        EduPlans plan = plansDao.getPlanById(review.get(0).getPlan_code());
        if (plan == null) {
            throw new SQLException("未找到计划");
        }

        for (EduPlanTransfer trans : transfers) {
            if (plan.getAdd_user().equals(trans.getTransfer_to_idcard())) {
                throw new SQLException("不能直接移交拟稿人" + trans.getTransfer_to_user() + "，请去掉拟稿人选择！");
            }
        }
        if (plan.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats()) {
            throw new SQLException("此计划已由处室废弃，不能再做修改！");
        }
        return plansDao.financeTransfer(review, transfers, cost) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public DataModel authFinance(EduReviews review, EduPlanCost cost) throws SQLException {
        EduPlanTransfer transfer = plansDao.getTransferById(review.getTransfer_code());
        if (transfer == null) {
            throw new SQLException("未找到移交记录");
        }
        if (transfer.getTrans_status() == EduReviewSimpleStatus.经办.getStats()) {
            throw new SQLException("已完成,不能修改！");
        }

        EduPlans plan = plansDao.getPlanById(review.getPlan_code());
        int persons = classDao.getPersonNum(plan.getPlan_code(), "");
        if (plan == null) {
            throw new SQLException("未找到计划");
        }
        if (plan.getPlan_status() == EduReviewSimpleStatus.处室废弃.getStats()) {
            throw new SQLException("此计划已由处室废弃，不能再做修改！");
        }
        if (persons == plan.getPlan_num()) {
            throw new SQLException("培训班总人数已达到该计划培训总人数" + persons + "人，不能再建班！");
        }
        int endnum = plan.getPlan_num() - persons;
        if (cost.getCost_persons() > endnum) {
            throw new SQLException("人数超标，还能安排" + endnum + "人！");
        }
        return plansDao.authFinance(review, cost) ? new DataModel().withInfo("执行成功") : new DataModel().withErr("执行失败");
    }

    @Override
    public List<EduPlanCost> getFinances(String plan_code) throws SQLException {
        return plansDao.getFinancesByPlan(plan_code);
    }

    @Override
    public List<EduSocTraintype> getSocTypes(Object... parmas) throws SQLException {
        return plansDao.getSocTypes(parmas);
    }

    @Override
    public List<EduSocialMainunit> getSocMainunits(Object... parmas) throws SQLException {
        return plansDao.getSocMainunits(parmas);
    }

    @Override
    public List<EduSocialExecunit> getSocExecunits(Object... parmas) throws SQLException {
        return plansDao.getSocExecunits(parmas);
    }

    @Override
    public List<EduHighspeedFlag> getSocHighFlages(Object... parmas) throws SQLException {
        return plansDao.getSocHighFlages(parmas);
    }

    @Override
    public List<EduAbroadType> getAbroadTypes(Object... parmas) throws SQLException {
        return plansDao.getAbroadTypes(parmas);
    }
}
